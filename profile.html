<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Driver Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --fg: #0f172a;          /* slate-900 */
      --muted: #475569;       /* slate-600 */
      --bg: #ffffff;
      --card: #f8fafc;        /* slate-50 */
      --primary: #2563eb;     /* blue-600 */
      --border: #e2e8f0;      /* slate-200 */
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      line-height: 1.4;
    }
    .wrap {
      max-width: 960px;
      margin: 24px auto;
      padding: 0 16px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px 16px;
      margin-bottom: 12px;
    }
    h1 {
      font-size: clamp(20px, 3vw, 28px);
      margin: 0;
    }
    .subtle {
      color: var(--muted);
      font-size: 14px;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0 16px;
    }
    button, .linklike {
      background: var(--primary);
      color: white;
      border: 0;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    button.secondary {
      background: #0ea5e9; /* sky-500 */
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }
    .chart-card {
      /* ðŸ‘‡ This keeps the chart from being gigantic */
      max-width: 900px;
      margin: 0 auto 14px;
    }
    .chart-wrap {
      position: relative;
      width: 100%;
      height: 360px;          /* fixed, so it wonâ€™t expand */
    }
    @media (max-width: 640px) {
      .chart-wrap { height: 280px; }
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 8px;
      font-size: 13px;
    }
    .stat {
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      text-align: center;
    }
    .stat .label {
      display: block;
      color: var(--muted);
      font-size: 12px;
    }
    footer {
      margin: 18px 0 32px;
      font-size: 14px;
    }
    a {
      color: var(--primary);
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1 id="title">Driver</h1>
      <span class="subtle" id="subtitle"></span>
    </header>

    <div class="controls">
      <button id="toggleOutliers" class="secondary">Hide outliers</button>
      <button id="resetZoom">Reset zoom</button>
    </div>

    <div class="card chart-card">
      <div class="chart-wrap">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="stats" id="statsRow" aria-live="polite">
      <!-- filled by JS -->
    </div>

    <footer id="driverLink"></footer>
  </div>

<script>
(async function() {
  // --- config ---
  const SITE_BASE = 'https://pgpkent.clubspeedtiming.com'; // change if you scrape a different ClubSpeed site
  const DATA_URL = 'data/all_laps.json';

  // --- helpers ---
  const qs = new URLSearchParams(location.search);
  const driverId = qs.get('id') || '';   // base64 CustID
  const driverName = (qs.get('name') || '').trim();

  function fmt(n, d=3) { return Number(n).toFixed(d); }
  function median(arr) {
    if (!arr.length) return NaN;
    const a = [...arr].sort((x,y)=>x-y);
    const mid = Math.floor(a.length/2);
    return a.length % 2 ? a[mid] : (a[mid-1] + a[mid]) / 2;
  }
  function quantile(arr, q) {
    if (!arr.length) return NaN;
    const a = [...arr].sort((x,y)=>x-y);
    const pos = (a.length - 1) * q;
    const base = Math.floor(pos), rest = pos - base;
    return a[base] + (a[base+1] !== undefined ? rest * (a[base+1]-a[base]) : 0);
  }
  function iqrFilter(values, k=1.5) {
    if (!values.length) return { keep: values, low: -Infinity, high: Infinity };
    const q1 = quantile(values, 0.25);
    const q3 = quantile(values, 0.75);
    const iqr = q3 - q1;
    const low = q1 - k * iqr;
    const high = q3 + k * iqr;
    return { low, high, keep: values.filter(v => v >= low && v <= high) };
  }
  function buildStats(yVals) {
    const count = yVals.length;
    const best = Math.min(...yVals);
    const mean = yVals.reduce((a,b)=>a+b,0) / (count || 1);
    const med = median(yVals);
    const p90 = quantile(yVals, 0.90);
    const latest = yVals[yVals.length-1];
    return { count, best, mean, med, p90, latest };
  }
  function renderStats(el, stats) {
    el.innerHTML = `
      <div class="stat"><span class="label">Laps</span>${stats.count}</div>
      <div class="stat"><span class="label">Best (s)</span>${fmt(stats.best)}</div>
      <div class="stat"><span class="label">Mean (s)</span>${fmt(stats.mean)}</div>
      <div class="stat"><span class="label">Median (s)</span>${fmt(stats.med)}</div>
      <div class="stat"><span class="label">p90 (s)</span>${fmt(stats.p90)}</div>
      <div class="stat"><span class="label">Latest (s)</span>${fmt(stats.latest)}</div>
    `;
  }

  // --- fetch data ---
  const res = await fetch(DATA_URL, { cache: 'no-store' });
  if (!res.ok) {
    document.getElementById('title').textContent = 'Driver (data error)';
    throw new Error('Unable to load all_laps.json');
  }
  const payload = await res.json();

  // Filter rows for this driver
  const rows = (payload.rows || []).filter(r => r.driver_id === driverId);
  // If name missing in query, derive from first row
  const displayName = driverName || (rows[0]?.driver_name ?? 'Driver');

  // Prepare chart data (x = chronological index; tooltip shows date/heat)
  rows.sort((a,b) => (a.heat_datetime_iso || '').localeCompare(b.heat_datetime_iso || ''));
  const labels = rows.map((r, i) => `${i+1}`);
  const laps = rows.map(r => Number(r.lap_seconds));
  const meta = rows.map(r => ({ heat: r.heat_no, date: r.heat_datetime_iso || '' }));

  // Set titles/links
  document.getElementById('title').textContent = displayName;
  document.getElementById('subtitle').textContent = `${rows.length} laps`;
  document.getElementById('driverLink').innerHTML =
    `<a href="${SITE_BASE}/sp_center/RacerHistory.aspx?CustID=${encodeURIComponent(driverId)}" target="_blank" rel="noopener">
      View on ClubSpeed â†—
     </a>`;

  // Build chart
  const ctx = document.getElementById('chart').getContext('2d');
  let filtered = false;
  let currentData = laps.slice();

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Lap time (s)',
        data: currentData,
        tension: 0.25,
        pointRadius: 2.5,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  // ðŸ‘ˆ important for fixed-height container
      scales: {
        x: {
          title: { display: true, text: 'Lap # (chronological across heats)' },
          grid: { display: false }
        },
        y: {
          title: { display: true, text: 'Seconds (lower is faster)' },
          ticks: { callback: v => v.toFixed(0) }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            title: items => {
              const i = items[0].dataIndex;
              const m = meta[i];
              const date = m?.date ? new Date(m.date).toLocaleString() : '';
              return `Lap ${i+1} â€¢ Heat ${m?.heat ?? ''}${date ? ` â€¢ ${date}` : ''}`;
            },
            label: item => ` ${item.dataset.label}: ${fmt(item.parsed.y)}s`
          }
        },
        legend: { display: false }
      }
    }
  });

  // Stats
  const statsEl = document.getElementById('statsRow');
  renderStats(statsEl, buildStats(currentData));

  // Hide/Show outliers (IQR)
  const btn = document.getElementById('toggleOutliers');
  btn.addEventListener('click', () => {
    if (!filtered) {
      const { low, high } = iqrFilter(laps, 1.5);
      currentData = laps.map(v => (v >= low && v <= high) ? v : NaN); // keep positions, hide outliers
      btn.textContent = 'Show outliers';
    } else {
      currentData = laps.slice();
      btn.textContent = 'Hide outliers';
    }
    filtered = !filtered;
    chart.data.datasets[0].data = currentData;
    chart.update();
    const visible = currentData.filter(v => !Number.isNaN(v));
    renderStats(statsEl, buildStats(visible));
  });

  // Reset "zoom" (here: just revert filter & y-range)
  document.getElementById('resetZoom').addEventListener('click', () => {
    filtered = false;
    btn.textContent = 'Hide outliers';
    currentData = laps.slice();
    chart.data.datasets[0].data = currentData;
    chart.options.scales.y.min = undefined;
    chart.options.scales.y.max = undefined;
    chart.update();
    renderStats(statsEl, buildStats(currentData));
    // scroll to chart top (handy on mobile)
    document.querySelector('.chart-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
})();
</script>
</body>
</html>
