<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Driver Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --fg: #0f172a;
      --muted: #475569;
      --bg: #ffffff;
      --card: #f8fafc;
      --primary: #2563eb;
      --border: #e2e8f0;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height: 1.4;
    }
    .wrap {
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px 16px;
      margin-bottom: 12px;
    }
    h1 {
      font-size: clamp(20px, 3vw, 28px);
      margin: 0;
    }
    .subtle { color: var(--muted); font-size: 14px; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0 16px; }
    button {
      background: var(--primary);
      color: white;
      border: 0;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    button.secondary { background: #0ea5e9; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .chart-card { margin: 0 auto 14px; }
    .chart-wrap {
      position: relative;
      width: 100%;
      height: 240px;     /* ðŸ‘ˆ desktop chart height */
    }
    @media (max-width: 640px) {
      .chart-wrap { height: 180px; }   /* ðŸ‘ˆ mobile chart height */
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 6px;
      font-size: 13px;
    }
    .stat {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px;
      text-align: center;
    }
    .stat .label { display: block; color: var(--muted); font-size: 12px; }
    footer { margin: 18px 0 32px; font-size: 14px; }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">Driver</h1>
      <span class="subtle" id="subtitle"></span>
    </header>

    <div class="controls">
      <button id="toggleOutliers" class="secondary">Hide outliers</button>
      <button id="toggleOutLaps" class="secondary">Ignore out laps</button>
      <button id="resetZoom">Reset</button>
    </div>

    <div class="card chart-card">
      <div class="chart-wrap"><canvas id="chart"></canvas></div>
    </div>

    <div class="stats" id="statsRow"></div>
    <footer id="driverLink"></footer>
  </div>

<script>
(async function() {
  const SITE_BASE = 'https://pgpkent.clubspeedtiming.com';
  const DATA_URL = 'data/all_laps.json';
  const qs = new URLSearchParams(location.search);
  const driverId = qs.get('id') || '';
  const driverName = (qs.get('name') || '').trim();

  function fmt(n,d=3){return Number(n).toFixed(d);}
  function median(a){if(!a.length)return NaN;const s=[...a].sort((x,y)=>x-y);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;}
  function quantile(a,q){if(!a.length)return NaN;const s=[...a].sort((x,y)=>x-y);const pos=(s.length-1)*q,base=Math.floor(pos),rest=pos-base;return s[base]+(s[base+1]!==undefined?rest*(s[base+1]-s[base]):0);}
  function iqrFilter(v,k=1.5){if(!v.length)return{low:-Infinity,high:Infinity};const q1=quantile(v,0.25),q3=quantile(v,0.75),iqr=q3-q1;return{low:q1-k*iqr,high:q3+k*iqr};}
  function buildStats(y){if(!y.length)return{count:0,best:NaN,mean:NaN,med:NaN,p90:NaN,latest:NaN};const c=y.length,best=Math.min(...y),mean=y.reduce((a,b)=>a+b,0)/c,med=median(y),p90=quantile(y,0.9),latest=y[y.length-1];return{count:c,best,mean,med,p90,latest};}
  function renderStats(el,s){el.innerHTML=`<div class="stat"><span class="label">Laps</span>${s.count}</div>
    <div class="stat"><span class="label">Best</span>${fmt(s.best)}</div>
    <div class="stat"><span class="label">Mean</span>${fmt(s.mean)}</div>
    <div class="stat"><span class="label">Median</span>${fmt(s.med)}</div>
    <div class="stat"><span class="label">p90</span>${fmt(s.p90)}</div>
    <div class="stat"><span class="label">Latest</span>${fmt(s.latest)}</div>`;}

  const res=await fetch(DATA_URL,{cache:'no-store'});
  const payload=await res.json();
  const rows=(payload.rows||[]).filter(r=>r.driver_id===driverId);
  rows.sort((a,b)=>(a.heat_datetime_iso||'').localeCompare(b.heat_datetime_iso||''));
  const displayName=driverName||rows[0]?.driver_name||'Driver';
  document.getElementById('title').textContent=displayName;
  document.getElementById('subtitle').textContent=`${rows.length} laps`;
  document.getElementById('driverLink').innerHTML=`<a href="${SITE_BASE}/sp_center/RacerHistory.aspx?CustID=${encodeURIComponent(driverId)}" target="_blank">View on ClubSpeed â†—</a>`;

  const meta=rows.map(r=>({lap:Number(r.lap_number),heat:r.heat_no,date:r.heat_datetime_iso||''}));
  const laps=rows.map(r=>Number(r.lap_seconds));
  const ctx=document.getElementById('chart').getContext('2d');

  let filtered=false, ignoreOutLaps=false;
  function filteredData(){
    let data=laps.map((v,i)=>({y:v,lap:meta[i].lap}));
    if(ignoreOutLaps) data=data.map(d=>d.lap===1?{...d,y:NaN}:d);
    if(filtered){
      const vals=data.filter(d=>!isNaN(d.y)).map(d=>d.y);
      const {low,high}=iqrFilter(vals,1.5);
      data=data.map(d=>(d.y>=low&&d.y<=high)?d:{...d,y:NaN});
    }
    return data.map(d=>d.y);
  }

  const chart=new Chart(ctx,{
    type:'line',
    data:{labels:rows.map((_,i)=>`${i+1}`),datasets:[{label:'Lap time (s)',data:filteredData(),tension:0.25,pointRadius:2.5,borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });

  const statsEl=document.getElementById('statsRow');
  renderStats(statsEl,buildStats(laps));

  document.getElementById('toggleOutliers').onclick=()=>{
    filtered=!filtered;
    document.getElementById('toggleOutliers').textContent=filtered?'Show outliers':'Hide outliers';
    chart.data.datasets[0].data=filteredData();chart.update();
    renderStats(statsEl,buildStats(chart.data.datasets[0].data.filter(v=>!isNaN(v))));
  };

  document.getElementById('toggleOutLaps').onclick=()=>{
    ignoreOutLaps=!ignoreOutLaps;
    document.getElementById('toggleOutLaps').textContent=ignoreOutLaps?'Include out laps':'Ignore out laps';
    chart.data.datasets[0].data=filteredData();chart.update();
    renderStats(statsEl,buildStats(chart.data.datasets[0].data.filter(v=>!isNaN(v))));
  };

  document.getElementById('resetZoom').onclick=()=>{
    filtered=false;ignoreOutLaps=false;
    document.getElementById('toggleOutliers').textContent='Hide outliers';
    document.getElementById('toggleOutLaps').textContent='Ignore out laps';
    chart.data.datasets[0].data=filteredData();chart.update();
    renderStats(statsEl,buildStats(laps));
  };
})();
</script>
</body>
</html>
