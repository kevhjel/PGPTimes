<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Driver Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --bg: #0f172a;
      --card: #1e293b;
      --primary: #3b82f6;
      --border: #334155;
    }
    html, body {
      margin: 0; padding: 0;
      background: var(--bg); color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height: 1.35;
    }
    .wrap { max-width: 860px; margin: 12px auto; padding: 0 12px; }
    header { display: flex; flex-wrap: wrap; align-items: center; gap: 6px 12px; margin-bottom: 8px; }
    h1 { font-size: clamp(18px, 2.6vw, 24px); margin: 0; }
    .subtle { color: var(--muted); font-size: 12px }

    .controls { display: flex; gap: 6px; flex-wrap: wrap; margin: 8px 0 10px }
    button {
      background: var(--primary); color: #fff; border: 0;
      border-radius: 7px; padding: 6px 10px; font-size: 13px; cursor: pointer;
    }
    button.secondary { background: #0ea5e9 }
    .switch {
      display: inline-flex; align-items: center; gap: 6px;
      background: #1e293b; color: var(--fg);
      border: 1px solid var(--border); border-radius: 7px;
      padding: 4px 8px; font-size: 12px
    }

    .card { background: var(--card); border: 1px solid var(--border);
      border-radius: 10px; padding: 8px }
    .chart-card { margin: 0 auto 10px }
    /* Chart uses 60% of screen height */
    .chart-wrap { position: relative; width: 100%; height: 60vh }

    .stats {
      display: grid; grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 6px; font-size: 12px; margin-bottom: 10px
    }
    .stat { background: #0f172a; border: 1px solid var(--border);
      border-radius: 8px; padding: 6px; text-align: center }
    .stat .label { display: block; color: var(--muted); font-size: 11px }

    footer { margin: 12px 0 18px; font-size: 13px }
    a { color: var(--primary); text-decoration: none }
    a:hover { text-decoration: underline }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">Driver</h1>
      <span class="subtle" id="subtitle"></span>
    </header>

    <div class="controls">
      <button id="toggleOutliers" class="secondary">Hide outliers</button>
      <button id="toggleOutLaps" class="secondary">Ignore out laps</button>
      <span class="switch"><input type="checkbox" id="perfMode" checked> Performance mode</span>
      <span class="switch"><input type="checkbox" id="tooltips"> Tooltips</span>
      <button id="reset">Reset</button>
    </div>

    <div class="card chart-card">
      <div class="chart-wrap"><canvas id="chart"></canvas></div>
    </div>

    <div class="stats" id="statsRow"></div>
    <footer id="driverLink"></footer>
  </div>

<script>
(async function(){
  const SITE_BASE='https://pgpkent.clubspeedtiming.com';
  const DATA_URL='data/all_laps.json';

  const qs=new URLSearchParams(location.search);
  const driverId=qs.get('id')||'';
  const driverName=(qs.get('name')||'').trim();

  // helpers
  const fmt=(n,d=3)=>Number.isFinite(Number(n))?Number(n).toFixed(d):'–';
  const median=a=>{if(!a.length)return NaN;const s=[...a].sort((x,y)=>x-y);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;}
  const quantile=(a,q)=>{if(!a.length)return NaN;const s=[...a].sort((x,y)=>x-y);const pos=(s.length-1)*q,base=Math.floor(pos),rest=pos-base;return s[base]+(s[base+1]!==void 0?rest*(s[base+1]-s[base]):0);}
  const iqrBounds=(v,k=1.5)=>{if(!v.length)return{low:-Infinity,high:Infinity};const q1=quantile(v,0.25),q3=quantile(v,0.75),iqr=q3-q1;return{low:q1-k*iqr,high:q3+k*iqr};}
  const buildStats=y=>{const arr=y.filter(v=>!Number.isNaN(v));if(!arr.length)return{count:0,best:NaN,mean:NaN,med:NaN,p90:NaN,latest:NaN};const count=arr.length,best=Math.min(...arr),mean=arr.reduce((a,b)=>a+b,0)/count,med=median(arr),p90=quantile(arr,0.9),latest=arr[arr.length-1];return{count,best,mean,med,p90,latest};}
  const renderStats=(el,s)=>{el.innerHTML=`
    <div class="stat"><span class="label">Laps</span>${s.count}</div>
    <div class="stat"><span class="label">Best</span>${fmt(s.best)}</div>
    <div class="stat"><span class="label">Mean</span>${fmt(s.mean)}</div>
    <div class="stat"><span class="label">Median</span>${fmt(s.med)}</div>
    <div class="stat"><span class="label">p90</span>${fmt(s.p90)}</div>
    <div class="stat"><span class="label">Latest</span>${fmt(s.latest)}</div>`;}

  // fetch data
  const res=await fetch(DATA_URL,{cache:'no-store'});
  if(!res.ok){document.getElementById('title').textContent='Driver (data error)';return;}
  const payload=await res.json();
  const rows=(payload.rows||[]).filter(r=>r.driver_id===driverId);
  rows.sort((a,b)=>(a.heat_datetime_iso||'').localeCompare(b.heat_datetime_iso||''));

  const displayName=driverName||rows[0]?.driver_name||'Driver';
  document.getElementById('title').textContent=displayName;
  document.getElementById('subtitle').textContent=`${rows.length} laps`;
  document.getElementById('driverLink').innerHTML=
    `<a href="${SITE_BASE}/sp_center/RacerHistory.aspx?CustID=${encodeURIComponent(driverId)}" target="_blank" rel="noopener">View on ClubSpeed ↗</a>`;

  const labels=rows.map((_,i)=>`${i+1}`);
  const meta=rows.map(r=>({lap:Number(r.lap_number),heat:r.heat_no,date:r.heat_datetime_iso||''}));
  const allLaps=rows.map(r=>Number(r.lap_seconds));

  // Chart.js defaults
  Chart.defaults.color= getComputedStyle(document.documentElement).getPropertyValue('--fg');
  Chart.defaults.plugins.legend.display=false;
  Chart.defaults.elements.point.radius=0;

  const ctx=document.getElementById('chart').getContext('2d');

  let hideOutliers=false, ignoreOutLaps=true, perfMode=true, tooltips=false;

  function computeData(){
    let data=allLaps.map((y,i)=>({y,lap:meta[i].lap}));
    if(ignoreOutLaps) data=data.map(d=>d.lap===1?{...d,y:NaN}:d);
    if(hideOutliers){
      const vals=data.filter(d=>!Number.isNaN(d.y)).map(d=>d.y);
      const {low,high}=iqrBounds(vals,1.5);
      data=data.map(d=>(d.y>=low && d.y<=high)?d:{...d,y:NaN});
    }
    return data.map(d=>d.y);
  }

  function makeOptions(){
    return {
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:'nearest',intersect:false},
      scales:{
        x:{grid:{color:'#334155'},ticks:{color:'#94a3b8'}},
        y:{grid:{color:'#334155'},ticks:{color:'#94a3b8'}}
      },
      plugins:{
        tooltip:{enabled:tooltips}
      }
    };
  }

  const chart=new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{ label:'Lap time (s)', data: computeData(), borderColor:'#3b82f6', spanGaps:true }] },
    options: makeOptions()
  });

  const statsEl=document.getElementById('statsRow');
  const updateStats=()=>renderStats(statsEl, buildStats(chart.data.datasets[0].data.filter(v=>!Number.isNaN(v))));
  updateStats();

  // controls
  document.getElementById('toggleOutliers').onclick=()=>{
    hideOutliers=!hideOutliers;
    chart.data.datasets[0].data=computeData(); chart.update(); updateStats();
  };
  document.getElementById('toggleOutLaps').onclick=()=>{
    ignoreOutLaps=!ignoreOutLaps;
    chart.data.datasets[0].data=computeData(); chart.update(); updateStats();
  };
  document.getElementById('perfMode').onchange=(e)=>{
    perfMode=e.target.checked; chart.update(); updateStats();
  };
  document.getElementById('tooltips').onchange=(e)=>{
    tooltips=e.target.checked; chart.options=makeOptions(); chart.update();
  };
  document.getElementById('reset').onclick=()=>{
    hideOutliers=false; ignoreOutLaps=true; perfMode=true; tooltips=false;
    chart.data.datasets[0].data=computeData(); chart.options=makeOptions(); chart.update(); updateStats();
  };
})();
</script>
</body>
</html>
