<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Driver Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --bg: #0b1220;
      --card: #111827;
      --primary: #60a5fa;
      --trend: #22d3ee;
      --border: #1f2937;
      --grid: #253042;
      --bad: #ef4444;
      --warn: #f59e0b;
      --ok: #10b981;
    }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; line-height: 1.35; }
    .wrap { max-width: 980px; margin: 12px auto; padding: 0 12px; }

    header { display: flex; flex-wrap: wrap; align-items: center; gap: 6px 12px; margin-bottom: 10px; }
    h1 { font-size: clamp(18px, 2.6vw, 24px); margin: 0; }
    .subtle { color: var(--muted); font-size: 12px }

    .back-link{
      display:inline-block; padding:6px 10px; border:1px solid var(--border);
      border-radius:8px; background:var(--card); color:var(--fg); text-decoration:none; font-size:13px; line-height:1;
    }
    .back-link:hover{ text-decoration:underline }

    .notice {
      background: #0f172a; border: 1px solid var(--border); border-left: 4px solid var(--warn);
      border-radius: 8px; padding: 8px 10px; font-size: 13px; margin: 8px 0 12px; display: none;
    }
    .notice.error { border-left-color: var(--bad); }
    .notice.ok    { border-left-color: var(--ok); }

    .controls { display: flex; gap: 10px 14px; flex-wrap: wrap; align-items: center; margin: 8px 0 12px }
    .check { display: inline-flex; align-items: center; gap: 8px; background: var(--card); color: var(--fg);
      border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; font-size: 13px; }
    .check input { transform: scale(1.15); accent-color: var(--primary); }
    .btn { background: var(--primary); color: #0b1220; border: 0; border-radius: 8px; padding: 8px 12px; font-size: 13px; cursor: pointer; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px }
    .chart-card { margin: 0 auto 12px }
    .chart-wrap { position: relative; width: 100%; height: 60vh } /* chart height */

    .stats { display: grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap: 8px; font-size: 12px; margin-bottom: 10px; }
    .stat { background: #0f172a; border: 1px solid var(--border); border-radius: 8px; padding: 8px; text-align: center }
    .stat .label { display: block; color: var(--muted); font-size: 11px }

    footer { margin: 12px 0 24px; font-size: 13px }
    a { color: var(--primary); text-decoration: none }
    a:hover { text-decoration: underline }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="index.html" class="back-link">← Back</a>
      <h1 id="title">Driver</h1>
      <span class="subtle" id="subtitle"></span>
    </header>

    <!-- runtime diagnostics -->
    <div id="notice" class="notice"></div>

    <div class="controls">
      <label class="check"><input type="checkbox" id="chkOutliers" /> Hide outliers</label>
      <label class="check"><input type="checkbox" id="chkOutLaps" checked /> Ignore out laps</label>
      <label class="check"><input type="checkbox" id="chkTooltips" /> Tooltips</label>
      <button id="btnReset" class="btn">Reset</button>
    </div>

    <div class="card chart-card">
      <div class="chart-wrap"><canvas id="chart"></canvas></div>
    </div>

    <div class="stats" id="statsRow"></div>
    <footer id="driverLink"></footer>
  </div>

<script>
(async function(){
  const SITE_BASE='https://pgpkent.clubspeedtiming.com';
  const JSON_URL='data/all_laps.json';
  const CSV_URL ='data/all_laps.csv';

  const qs=new URLSearchParams(location.search);
  const driverId=qs.get('id')||'';
  const driverName=(qs.get('name')||'').trim();

  // ---------- helpers ----------
  const $ = sel => document.querySelector(sel);
  const showNotice = (msg, type='warn') => {
    const n = $('#notice');
    n.textContent = msg;
    n.className = 'notice ' + (type==='error' ? 'error' : type==='ok' ? 'ok' : '');
    n.style.display = 'block';
  };
  const fmt=(n,d=3)=>Number.isFinite(Number(n))?Number(n).toFixed(d):'–';
  const median=a=>{if(!a.length)return NaN;const s=[...a].sort((x,y)=>x-y);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;}
  const quantile=(a,q)=>{if(!a.length)return NaN;const s=[...a].sort((x,y)=>x-y);const pos=(s.length-1)*q,base=Math.floor(pos),rest=pos-base;return s[base]+(s[base+1]!==void 0?rest*(s[base+1]-s[base]):0);}
  const iqrBounds=(v,k=1.5)=>{if(!v.length)return{low:-Infinity,high:Infinity};const q1=quantile(v,0.25),q3=quantile(v,0.75),iqr=q3-q1;return{low:q1-k*iqr,high:q3+k*iqr};}
  const buildStats=y=>{const arr=y.filter(v=>!Number.isNaN(v));if(!arr.length)return{count:0,best:NaN,mean:NaN,med:NaN,p90:NaN,latest:NaN};const count=arr.length,best=Math.min(...arr),mean=arr.reduce((a,b)=>a+b,0)/count,med=median(arr),p90=quantile(arr,0.9),latest=arr[arr.length-1];return{count,best,mean,med,p90,latest};}
  const renderStats=(el,s)=>{el.innerHTML=`
    <div class="stat"><span class="label">Laps</span>${s.count}</div>
    <div class="stat"><span class="label">Best</span>${fmt(s.best)}</div>
    <div class="stat"><span class="label">Mean</span>${fmt(s.mean)}</div>
    <div class="stat"><span class="label">Median</span>${fmt(s.med)}</div>
    <div class="stat"><span class="label">p90</span>${fmt(s.p90)}</div>
    <div class="stat"><span class="label">Latest</span>${fmt(s.latest)}</div>`;}

  // ---------- data loaders ----------
  async function loadJSONRows(){
    try{
      const res = await fetch(`${JSON_URL}?v=${Date.now()}`, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const payload = await res.json();
      const rows = (payload.rows||[]).filter(r => r.driver_id === driverId);
      return rows;
    }catch(err){
      showNotice(`Could not load all_laps.json (${err.message}). Will try CSV fallback.`, 'warn');
      return null; // signal: try CSV
    }
  }

  function parseCSV(text){
    const out = [];
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length === 0) return out;
    const header = lines[0].split(',').map(s => s.trim());
    const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
    for(let i=1;i<lines.length;i++){
      const parts = lines[i].split(','); // simple split (no quoted commas in our file)
      if(parts.length < header.length) continue;
      out.push({
        driver_name: parts[idx.driver_name],
        driver_id: parts[idx.driver_id],
        heat_no: parts[idx.heat_no],
        heat_datetime_iso: parts[idx.heat_datetime_iso],
        lap_number: Number(parts[idx.lap_number]),
        lap_seconds: Number(parts[idx.lap_seconds])
      });
    }
    return out;
  }

  async function loadCSVRows(){
    try{
      const res = await fetch(`${CSV_URL}?v=${Date.now()}`, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const all  = parseCSV(text);
      const rows = all.filter(r => r.driver_id === driverId);
      showNotice(`Using CSV fallback (${rows.length} laps loaded).`, 'ok');
      return rows;
    }catch(err){
      showNotice(`Could not load CSV fallback (${err.message}).`, 'error');
      return [];
    }
  }

  // ---------- fetch data with fallback ----------
  let rows = await loadJSONRows();
  if (rows === null || rows.length === 0) {
    // JSON missing or empty for this driver → try CSV
    const viaCSV = await loadCSVRows();
    if (rows === null) rows = viaCSV;
    else if (rows.length === 0 && viaCSV.length > 0) rows = viaCSV;
  }

  // ---------- setup header/link ----------
  const displayName = (new URLSearchParams(location.search).get('name')||'').trim() || rows[0]?.driver_name || 'Driver';
  document.getElementById('title').textContent = displayName;
  document.getElementById('subtitle').textContent = `${rows.length} laps`;
  document.getElementById('driverLink').innerHTML =
    `<a href="${SITE_BASE}/sp_center/RacerHistory.aspx?CustID=${encodeURIComponent(driverId)}" target="_blank" rel="noopener">View on ClubSpeed ↗</a>`;

  if (!rows || rows.length === 0) {
    showNotice('No laps found for this driver on the site data. If you just ran the scraper, give GitHub Pages a minute and refresh.', 'warn');
  }

  // ---------- chart prep ----------
  rows.sort((a,b)=>(a.heat_datetime_iso||'').localeCompare(b.heat_datetime_iso||''));
  const N = rows.length;
  const meta   = rows.map(r=>({ lap:Number(r.lap_number), heat:r.heat_no, date:r.heat_datetime_iso||'' }));
  const yAll   = rows.map(r=>Number(r.lap_seconds));

  // Chart.js dark defaults
  Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim();
  Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
  Chart.defaults.plugins.legend.display = false;
  Chart.defaults.animation = false;
  Chart.defaults.responsiveAnimationDuration = 0;

  const ctx=document.getElementById('chart').getContext('2d');

  // toggles
  const chkOutliers = document.getElementById('chkOutliers');
  const chkOutLaps  = document.getElementById('chkOutLaps');
  const chkTooltips = document.getElementById('chkTooltips');

  const quantile=(a,q)=>{if(!a.length)return NaN;const s=[...a].sort((x,y)=>x-y);const pos=(s.length-1)*q,base=Math.floor(pos),rest=pos-base;return s[base]+(s[base+1]!==void 0?rest*(s[base+1]-s[base]):0);}
  const iqrBounds=(v,k=1.5)=>{if(!v.length)return{low:-Infinity,high:Infinity};const q1=quantile(v,0.25),q3=quantile(v,0.75),iqr=q3-q1;return{low:q1-k*iqr,high:q3+k*iqr};}

  function filteredPoints(){
    let pts = yAll.map((y,i)=>({ x: i+1, y, lap: meta[i].lap, heat: meta[i].heat, date: meta[i].date }));
    if (chkOutLaps.checked)  pts = pts.map(p => p.lap === 1 ? { ...p, y: NaN } : p);
    if (chkOutliers.checked) {
      const vals = pts.filter(p => Number.isFinite(p.y)).map(p => p.y);
      const {low, high} = iqrBounds(vals, 1.5);
      pts = pts.map(p => (p.y >= low && p.y <= high) ? p : { ...p, y: NaN });
    }
    return pts;
  }

  function linearRegression(points){
    const pts = points.filter(p => Number.isFinite(p.y));
    const n = pts.length; if (n < 2) return { m: 0, b: NaN, ok: false };
    let sx=0, sy=0, sxy=0, sxx=0;
    for(const p of pts){ sx+=p.x; sy+=p.y; sxy+=p.x*p.y; sxx+=p.x*p.x; }
    const denom = (n*sxx - sx*sx); if (!denom) return { m:0, b:NaN, ok:false };
    const m = (n*sxy - sx*sy) / denom, b = (sy - m*sx)/n;
    return { m, b, ok: true };
  }

  function makeDatasets(){
    const pts = filteredPoints();
    const scatter = {
      type: 'scatter',
      label: 'Lap time (s)',
      data: pts.map(p => ({ x: p.x, y: p.y })),
      pointRadius: 2, pointHoverRadius: 3,
      pointBackgroundColor: 'rgba(96,165,250,0.9)',
      pointBorderColor: 'rgba(96,165,250,0.9)',
      showLine: false, spanGaps: true, parsing: false,
    };
    const lr = linearRegression(pts);
    let trend = {
      type: 'line', label: 'Trend', data: [],
      borderColor: getComputedStyle(document.documentElement).getPropertyValue('--trend').trim() || '#22d3ee',
      borderWidth: 2, pointRadius: 0, tension: 0, spanGaps: true, parsing: false,
    };
    const xs = pts.filter(p => Number.isFinite(p.y)).map(p => p.x);
    if (lr.ok && xs.length) trend.data = [{x: Math.min(...xs), y: lr.m*Math.min(...xs)+lr.b}, {x: Math.max(...xs), y: lr.m*Math.max(...xs)+lr.b}];
    return [scatter, trend];
  }

  function makeOptions(){
    return {
      responsive: true, maintainAspectRatio: false, normalized: true,
      scales: {
        x: { type: 'linear', min: 1, max: Math.max(1, N),
             grid: { color: 'rgba(37,48,66,0.6)' }, ticks: { color: 'var(--muted)' },
             title: { display: true, text: 'Lap # (chronological across heats)' } },
        y: { grid: { color: 'rgba(37,48,66,0.6)' },
             ticks: { color: 'var(--muted)', callback: v => Number.isFinite(v) ? v.toFixed(0) : '' },
             title: { display: true, text: 'Seconds (lower is faster)' } }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: chkTooltips.checked,
          callbacks: {
            title: (items) => `Point ${items[0].dataIndex + 1}`,
            label: (item) => {
              const idx = item.dataIndex;
              const p = filteredPoints()[idx];
              const lapStr  = Number.isFinite(p?.lap)  ? `Lap #${p.lap}` : 'Lap –';
              const heatStr = p?.heat ? `Heat ${p.heat}` : 'Heat –';
              const valStr  = Number.isFinite(item.parsed.y) ? `${fmt(item.parsed.y)}s` : '–';
              return ` ${lapStr} • ${heatStr} • ${valStr}`;
            }
          }
        }
      }
    };
  }

  const ctx = document.getElementById('chart').getContext('2d');
  const chart = new Chart(ctx, { data: { datasets: makeDatasets() }, options: makeOptions() });

  const statsEl = document.getElementById('statsRow');
  function updateStatsFromChart(){
    const data = chart.data.datasets[0].data.map(p => p.y).filter(v => Number.isFinite(v));
    const s = (function(y){ const arr=y.filter(v=>!Number.isNaN(v)); if(!arr.length) return {count:0,best:NaN,mean:NaN,med:NaN,p90:NaN,latest:NaN};
      const count=arr.length,best=Math.min(...arr),mean=arr.reduce((a,b)=>a+b,0)/count;
      const med=(a=>{const s=[...a].sort((x,y)=>x-y);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;})(arr);
      const p90=(a=>{const s=[...a].sort((x,y)=>x-y);const pos=(s.length-1)*0.9,base=Math.floor(pos),rest=pos-base;return s[base]+(s[base+1]!==void 0?rest*(s[base+1]-s[base]):0);})(arr);
      return {count,best,mean,med,p90,latest:arr[arr.length-1]}; })(data);
    statsEl.innerHTML = `
      <div class="stat"><span class="label">Laps</span>${s.count}</div>
      <div class="stat"><span class="label">Best</span>${fmt(s.best)}</div>
      <div class="stat"><span class="label">Mean</span>${fmt(s.mean)}</div>
      <div class="stat"><span class="label">Median</span>${fmt(s.med)}</div>
      <div class="stat"><span class="label">p90</span>${fmt(s.p90)}</div>
      <div class="stat"><span class="label">Latest</span>${fmt(s.latest)}</div>`;
  }
  updateStatsFromChart();

  function rebuild(){
    chart.data.datasets = makeDatasets();
    chart.options = makeOptions();
    chart.update();
    updateStatsFromChart();
  }
  document.getElementById('chkOutliers').onchange = rebuild;
  document.getElementById('chkOutLaps').onchange  = rebuild;
  document.getElementById('chkTooltips').onchange = rebuild;

  document.getElementById('btnReset').onclick = () => {
    document.getElementById('chkOutliers').checked = false;
    document.getElementById('chkOutLaps').checked  = true;
    document.getElementById('chkTooltips').checked = false;
    rebuild();
    document.querySelector('.chart-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };
})();
</script>
</body>
</html>
